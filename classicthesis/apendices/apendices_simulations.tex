%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Simulation details}
\label{appex_simulations}

In this Appendix we briefly describe the steps involved in the generation of gauge field configurations with dynamical quarks in the framework of Lattice QCD simulations.

After discretizing QCD in a finite volume and Euclidean spacetime, a very large number of degrees of freedom have to be integrated over in the path integral formulation, including the contribution of the fermionic determinant of the dynamical quarks. In recent years, important advances in lattice QCD computations have allowed to incorporate the effects of dynamical quarks in the vicinity of their physical values.

The CLS ensembles employed in this work have been generated with the openQCD package~\citep{Luscher:2012av,Luscher:2010ae}. In the following we will provide a brief account of some of the algorithms incorporated in the openQCD simulation programs.

As outlined in Sec.~\ref{ch_foundation:sec:path}, the expectation value of a composite operator $O$ can be computed on the lattice as
\begin{equation}
\left<O\right>=\frac{1}{\mathcal{Z}}\int\mathcal{D}[U]e^{-S_{\textrm{G}}[U]-S_{\textrm{eff}}[U]}O[U]\approx\frac{1}{N_{\textrm{cnfg}}}\sum_{i=1}^{N_{\textrm{cnfg}}}O[U_i]+\mathcal{O}\left(\frac{1}{\sqrt{N_{\textrm{cnfg}}}}\right),
\end{equation}
where the gauge fields $U_i$ are sampled from the probability density
\begin{equation}
\label{appex_simulations:eq:PU}
P[U]=\frac{e^{-S_{\textrm{G}}[U]-S_{\textrm{eff}}[U]}}{\int\mathcal{D}[U]e^{-S_{\textrm{G}}[U]-S_{\textrm{eff}}[U]}}.
\end{equation}

The central idea is to perform an importance sampling of the distribution in eq.~(\ref{appex_simulations:eq:PU}), such that regions of field space with high probability are highly populated with gauge configurations $U_i$. Markov chain Monte Carlo algorithms are a suitable tool to carry out such a configuration space sampling. The Markov chain is defined as a sequence $\{U_k\}_{k=1}^{N_{\textrm{cnfg}}}$ such that the $k$-th element is generated from the previous one, with $k$ labeling the Monte Carlo (MC) time. The Markov Chain is generated from an initial state $U_1$ and the transition probability $T(U_{k-1}\rightarrow U_k)$. As a result, the autocorrelations between successive gauge field configurations of a given Markov chain have to be analyzed, see Appendix~\ref{appex_errors}. The transition probabilities must obey the following conditions:
\begin{itemize}
\item Ergodicity: given a subset of states $S$ from the Markov Chain, there are always at least two states $s\in S$ and $s'\notin S$ with $T(s\rightarrow s')>0$. This is of particular importance in the context of Lattice QCD and Lattice Yang-Mills theories in order to ensure that the simulation algorithm is sampling correctly all topological sectors of the theory.
\item Equilibrium: normalizing the transition probability as
\begin{equation}
\sum_sT(s\rightarrow s')=1\;\;\;\;\forall s,
\end{equation}
then it must hold that
\begin{equation}
\sum_sP(s)T(s\rightarrow s')=P(s')\;\;\;\;\forall s',
\end{equation}
where $P(s)$ is the equilibrium distribution in eq.~(\ref{appex_simulations:eq:PU}). This ensures that starting from a random configuration, after applying iteratively the transition probability, we asymptotically reach the target equilibrium distribution in eq.~(\ref{appex_simulations:eq:PU}). 
\end{itemize}

Different choices for the transition probability $T(s\rightarrow s')$ satisfying the above conditions define the different sampling algorithms which we will now briefly review.

\section{Metropolis algorithm}

The Metropolis algorithm~\citep{Metropolis:1953am} is commonly employed for generating a Markov Chain of gauge field configurations for pure gauge theories, for which the target distribution is
\begin{equation}
P[U]=\frac{e^{-S_{\textrm{G}}[U]}}{\int\mathcal{D}[U]e^{-S_{\textrm{G}}[U]}}.
\end{equation}
The idea is to define an a priori selection probability $T_0(U_i\rightarrow U_j)$ to update a single gauge link. One such choice is to take a random element $g$ of the $SU(N)$ group close to the identity and update the gauge link $U_{\mu}(n)$ as $U_{\mu}(n)'=gU_{\mu}(n)$ such that the new gauge configuration $U_j$ is close to the original one $U_i$. In order for the transition to be symmetric, group elements $g$ and $g^{-1}$ have to be selected with equal probability. After updating with this a priori transition probability, one supplements the updating process with an accept-reject step, such that the new proposed gauge link is accepted with probability
\begin{gather}
P_{\textrm{acc}}(i,j)=\textrm{min}\left(1,e^{-\Delta S}\right), \quad \Delta S=S[U_j]-S[U_i].
\end{gather}
Then the total transition probability is given by 
\begin{equation}
T(U_i\rightarrow U_j)=T_0(U_i\rightarrow U_j)P_{\textrm{acc}}(i,j)+\delta_{ij}\sum_kT_0(U_i\rightarrow U_j)(1-P_{\textrm{acc}}(i,j)).
\end{equation}
This $T$ satisfies all the desired properties for a transition probability and asymptotically reaches the target distribution probability for pure gauge theories.

The drawback of this algorithm is that it only updates a single gauge link at each step and as such it becomes inefficient, particularly for large volume simulations. Over the years new alternatives for pure gauge simulations have been proposed, such as the heat bath~\citep{Creutz:1980zw} and overrelaxation~\citep{Adler:1981sn,Creutz:1987xi} algorithms.

\section{Hybrid Monte Carlo}

In the pure gauge theory, the probability distribution can be interpreted 
as being composed of infinitely heavy sea quarks. In order to simulate full QCD, one needs to incorporate dynamical quarks in the sea through the probability distribution in eq.~(\ref{appex_simulations:eq:PU}), where $S_{\textrm{eff}}$ introduces non-local dependencies in the gauge links due to the quark determinant. Therefore, algorithms such as the Metropolis algorithm,  based on a link-by-link update scheme of the gauge field configurations, experience a significant increase in computational cost as the volume is increased, which renders them impractical for large-scale dynamical simulations. The Hybrid Monte Carlo (HMC) algorithm~\citep{Duane:1987de,Gottlieb:1987mq} significantly improves the efficiency of the simulations by doing global updates of the gauge configurations.

The HMC uses the classical equations of motion to propose new gauge field configurations. To this purpose, the field space is extended with the introduction of the conjugate momenta $\pi_{\mu}(x)$ of the link variables $U_{\mu}(x)$. The Hamiltonian of the system is
\begin{equation}
H[\pi,U]=\frac{1}{2}\sum_{x,\mu}\pi_{\mu}^a(x)\pi_{\mu}^a(x)+S_{\textrm{G}}[U]+S_{\textrm{eff}}[U].
\end{equation}
The expectation values can be computed using
\begin{equation}
\left<O\right>=\frac{\int\mathcal{D}[\pi,U]e^{-H[\pi,U]}O[U]}{\int\mathcal{D}[\pi,U]e^{-H[\pi,U]}}.
\end{equation}
Now the classical equations of motion read
\begin{gather}
\dot{\pi}_{\mu}(x)=-F_{\mu}(x)=-F_{\mu}^a(x)T^a, \\
F_{\mu}^a(x)=\left.\frac{\partial S[e^{\omega T^a}U]}{\partial\omega}\right|_{\omega=0}, \quad a=1,...,8, \\
\dot{U}_{\mu}(x)=\pi_{\mu}(x)U_{\mu}(x),
\end{gather}
where the dot notation ``$\dot{a}$'' stands for the derivative with respect to MC time. By starting from an initial configuration and a randomly generated 
momentum field $\pi_{\mu}$ -- following a Gaussian  probability
density -- the integration of the equations of motion leads to a new gauge configuration to be used as proposal for the global update of the gauge links. This proposal is subject to an accept-reject step like in the Metropolis algorithm
\begin{gather}
P_{\textrm{acc}}=\textrm{min}\left(1,e^{-\Delta H}\right), \quad \Delta H=H[\pi',U']-H[\pi,U].
\end{gather}

In practice, this basic formulation of the HMC algorithm has to be complemented by efficient techniques to accurately integrate the equations of motion in simulations involving, for instance, light quark masses and large volumes~\citep{Weingarten:1991ra,OMELYAN2003272,Hasenbusch:2001ne}.

We now briefly discuss the methods used to compute the effective fermion action
\begin{equation}
S_{\textrm{eff}}[U]=-\sum_{i=1}^{N_f}\textrm{log det}(D_i).
\end{equation}
The fermionic determinant can be evaluated through the introduction of pseudofermion fields $\Phi(x)$~\citep{Weingarten:1980hx}, which are auxiliary fields that carry color and spinor indices $c,\alpha$ but that are complex valued instead of Grassmann numbers. Restricting to the mass-degenerate doublet of light quarks, where the effective action takes the form
\begin{equation}
e^{-S_{\textrm{eff}}}=\textrm{det}(D_l)\textrm{det}(D_l)=\textrm{det}(D_l^{\dagger}D_l),
\end{equation}
in the pseudo-fermion representation this becomes up to an irrelevant normalization factor $c$
\begin{equation}
\textrm{det}(D_l^{\dagger}D_l)=c\int\mathcal{D}[\Phi]e^{-S_{\textrm{pf}}[U,\Phi]},
\end{equation}
with the pseudo-fermion action given by
\begin{equation}
S_{\textrm{pf}}[U,\Phi]=\Phi^{\dagger}\left(D_l^{\dagger}D_l\right)^{-1}\Phi.
\end{equation}

We have listed the basic ingredients needed for HMC sampling with dynamical fermions. First, one samples randomly a set of conjugate momenta $\pi_{\mu}$ and pseudo-fermion fields $\Phi$ with Gaussian distribution $\propto\exp\left(-\frac{1}{2}\pi_{\mu}\pi_{\mu}-S_{\textrm{pf}}\right)$. Together with an initial gauge field configuration $U_{i}$, the classical equations of motion are integrated up to some later time. At this point one implements the accept-reject step and updates the gauge configuration to $U_{i+1}$.

This far we assumed two degenerate flavors of quarks to compute the effective fermion action. The inclusion of a strange quark, as in
the case of the CLS ensembles that we use in this work, requires the computation of $\textrm{det}(D_s)$. Contrary to the case of two degenerate quark flavors, $\textrm{det}(D_s)$ is not ensured to remain positive, since the breaking of chiral symmetry by the Wilson term implies that the low-lying spectrum of the Wilson Dirac operator does not have a strict gap, associated to the quark mass, at finite values of the lattice spacing. Therefore, possible changes in the sign of the strange quark determinant must be monitored throughout the Monte Carlo simulation. In the generation of CLS ensembles, the strange quark determinant is evaluated by the Rational Hybrid Monte Carlo algorithm~\citep{Kennedy:1998cu,Clark:2006fx}. In~\citep{Mohler:2020txx} it was found that on some ensembles, a subset of the gauge field configurations  were affected by a negative sign of the strange quark determinant. A reweighting procedure, discussed in the following section, can be used to correct for this effect.

\section{Reweighting}

In~\citep{Luscher:2008tw} it was proposed to perform a reweighting procedure in order to deal with exceptional gauge configurations in the HMC algorithm. These are gauge configurations with near to zero eigenvalues for the Dirac operator, which can appear due to the explicit chiral symmetry breaking induced by the Wilson term in the Wilson fermionic action.

In the context of CLS ensembles, a small twisted mass term $\mu_0$ is included in the light quark determinant as~\citep{Luscher:2012av}
\begin{equation}
\textrm{det}\left(Q^{\dagger}Q\right)\rightarrow\textrm{det}\left(\left(Q^{\dagger}Q+\mu_0^2\right)^2\left(Q^{\dagger}Q+2\mu_0^2\right)^{-1}\right),
\end{equation}
with the Hermitian Dirac operator given by $Q=\gamma_5D$. This provides an infrared cutoff for the low-lying eigenvalues. Using Hasenbusch’s mass factorization~\citep{Hasenbusch:2001ne}
\begin{align}
&\textrm{det}\left(\left(Q^{\dagger}Q+\mu_0^2\right)^2\left(Q^{\dagger}Q+2\mu_0^2\right)^{-1}\right) \\ 
&=\textrm{det}\left(Q^{\dagger}Q+\mu_{n}^2\right)\textrm{det}\left(\frac{Q^{\dagger}Q+\mu_{0}^2}{Q^{\dagger}Q+2\mu_0^2}\right)\times\Pi_{i=1}^{n}\textrm{det}\left(\frac{Q^{\dagger}Q+\mu_{i-1}^2}{Q^{\dagger}Q+\mu_i^2}\right),
\end{align}
where the twisted mass factors are ordered as $\mu_0<\mu_1<...<\mu_{n}$. 

The values of the twisted mass factors have to be properly selected to improve the stability of the simulations. To remove the unphysical effect of the auxiliary terms depending on the twisted mass parameters, a reweighting  procedure is applied consisting in computing reweighted expectation values over gauge configurations as
\begin{equation}
\left<O\right>_{\textrm{rw}}=\frac{\left<OW\right>}{\left<W\right>},
\end{equation}
where on the right-hand-side the expectation values are evaluated with a lattice action including the twisted mass parameters and $W$ is the corresponding reweighting factor
\begin{equation}
W=\textrm{det}\left(Q^{\dagger}Q\left(Q^{\dagger}Q+2\mu_0^2\right)\left(Q^{\dagger}Q+\mu_0^2\right)^{-2}\right).
\end{equation}

In addition to twisted mass reweighting, a reweighting procedure is also applied to remove the rational approximation introduced by the use of the RHMC algorithm to simulate the strange quark determinant~\citep{Kennedy:1998cu,Clark:2006fx}. In practice, we employ the reweighting factors computed with the low-mode deflation method in~\citep{Kuberski:2023zky}.

As mentioned in the previous section, in~\citep{Mohler:2020txx} it was found that a subset of the gauge configurations of some of the ensembles considered in this work have negative values of the strange quark determinant. This effect can corrected by the application of a reweighting factor that flips the sign of the configurations which were identified to have a negative sign of strange quark fermionic determinant. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

