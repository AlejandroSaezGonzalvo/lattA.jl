%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Least-squares fitting}
\label{apex_chisq}

We employ a least-squares method to fit our data to some fit function. This method is based on finding the  minimum of the $\chi^2$ function
\begin{equation}
\label{apex_chisq:eq:chisq}
\chi^2=\sum_{i,j=1}^{N_{\textrm{dat}}}\left(y_i-f(x_i;\vec{p})\right)C_{ij}^{-1}\left(y_j-f(x_j;\vec{p})\right),
\end{equation}
where $\{x_i,y_i\}_{i=1,...,N_{\textrm{dat}}}$ are the data points we want to fit, $x$ being the independent variable and $y$ the abscissa. $C^{-1}$ is the inverse of the covariance matrix of the $y$-data, and $f(x;\vec{p})$ is the fit function with fit parameters $\vec{p}=(p_1,...,p_{N_{\textrm{param}}})$. For a given fit function $f(x;\vec{p})$, the method finds the parameters values that minimize eq.~(\ref{apex_chisq:eq:chisq}) for given data points $\{x_i,y_i\}_{i=1,...,N_{\textrm{dat}}}$.

In our case we perform fits to extract the ground state signal of lattice observables, fitting e.g. an effective mass to a constant plus some exponential signals along the lattice time extent. In this case, euclidean time plays the role of the $x$. This means fitting $\sim96-192$ points, which in practice makes it very difficult to computate an invertible covariance matrix. In this scenario it is common to use not the full covariance matrix in eq.~(\ref{apex_chisq:eq:chisq}) but only its diagonal part. This is referred to as uncorrelated fit, as opposed to a fully correlated fit, which uses the full covariance matrix. However, after minimizing the $\chi^2$ using only the diagonal part of $C$, uncertainties are propagated taking into account all the correlations between the data.

We also perform fits for the chiral-continuum extrapolation of $\sqrt{8t_0}f_{\pi K}$ to set the scale. In this case, the $y$ variable is $\sqrt{8t_0}f_{\pi K}$ while the $x$ is $\phi_2$, and thus the latter has its own uncertainty. In this situation, a generalized $\chi^2$ function can be defined to include uncertainties in $x$ as
\begin{gather}
\label{apex_chisq:eq:chisq_generalized}
\chi^2=\sum_{i,j=1}^{2N_{\textrm{dat}}}\left(Y_i-F(X_i;\vec{p},\vec{q})\right)\mathcal{C}_{ij}^{-1}\left(Y_j-F(X_j;\vec{p},\vec{q})\right), \\
Y=(x_1,...,x_{N_{\textrm{dat}}},y_1,...,y_{N_{\textrm{dat}}}), \quad
X=(x_1,...,x_{N_{\textrm{dat}}},x_1,...,x_{N_{\textrm{dat}}}), \\
F(X_i;\vec{p},\vec{q})=\left\{\begin{matrix}
q_i & \textrm{ if $1\leq i\leq N_{\textrm{dat}}$} \\ 
f(x_i;\vec{p}) & \textrm{ if $N_{\textrm{dat}}+1\leq i\leq 2N_{\textrm{dat}}$}
\end{matrix}\right.,
\end{gather}
where $\mathcal{C}$ is now the covariance matrix of the generalized data vector $Y$. Again, since we have 16 different ensembles, a fully correlated fit means that we have $\sim32\times32$ covariance matrices which are hard to invert. For this reason, we use the $\chi^2$ definition in eq.~(\ref{apex_chisq:eq:chisq}) for the chiral-continuum extrapolation, i.e. we neglect the correlation between $\phi_2$ and $\sqrt{8t_0}f_{\pi K}$ in the definition of the $\chi^2$, but we use the full covariance matrix of the $\sqrt{8t_0}f_{\pi K}$ data. Again, to propagate errors we take into account all the correlations between the data, and in particular between $\phi_2$ and $\sqrt{8t_0}f_{\pi K}$.

In~\citep{Bruno:2022mfy} a method to measure the quality of the fit for uncorrelated fits is defined, in terms of a p-value. It is also defined a method to compute the expected value of the minimum of $\chi^2$, $\left<\chi^2\right>$. In the case of a fully correlated fit $\left<\chi^2\right>={\textrm{dof}}$. For the chiral-continuum fits, even though we neglect the uncertainties of $\phi_2$ and the correlation of it with $\sqrt{8t_0}f_{\pi K}$ in the definition of the $\chi^2$, we observe
\begin{equation}
\frac{\left<\chi^2\right>}{{\textrm{dof}}}\sim0.98.
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

